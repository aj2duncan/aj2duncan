---
title: A Discussion on Pipes
author: ''
date: '2023-05-31'
slug: a-discussion-on-pipes
categories:
  - R
tags:
  - dplyr
description: ''
highlight: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(eval = TRUE, echo = TRUE, comment = NA, 
                      warning = FALSE, message = FALSE)
```

I'm a little late to the party on this but I thought that I would add a post about it because it is something that relates to my teaching and I was slightly surprised by the conclusion I ended up coming to. The topic is piping and the strengths and weaknesses of the `magrittr` pipe `%>%` versus the (relatively) new base pipe `|>`.

The background to this post is that I was making a general move towards switching from `%>%` to `|>`. That is, when I started writing some brand new code in a brand new RStudio project (and git repo), I changed to using `|>`. Some of this new code generated a weird error and on fixing it I ended up doing a deeper dive into the base pipe and that led to this post.

Before I get too much further I would just add that I am a big fan of the pipe and piped operations. In my opinion it generates far more readable code than base `R` (prior to the pipe). I personally use it all the time and introduce it to my students as soon as I think is reasonably sensible.

Anyway, onto the discussion and the secondary reason for the post - to give me something to refer back to when I forget the specifics. I've used the magrittr pipe `%>%` for ages and the example below (from the old version of the `map()` help page) is a good example of where I might use it.

```{r}
library(tidyverse)

mtcars %>% 
  split(.$cyl) %>%
  map(~ lm(mpg ~ wt, data = .x)) %>%
  map(summary) %>%
  map_dbl("r.squared")
```

On digging into the base pipe, which I was using as part of `map()` call, I used `?map` and got the updated version of the above code.

```{r}
mtcars |>
  group_split(mtcars$cyl) |>
  map(\(df) lm(mpg ~ wt, data = df)) |>
  map(summary) |>
  map_dbl("r.squared")
```

These two pieces of code look reasonably similar but you'll notice the lack of `.` notation in the second. This led me reading about `|>` and the differences. In turn I found this excellent [blog post](https://ivelasq.rbind.io/blog/understanding-the-r-pipe/) that provided better examples than I found in other documentation. For me the crux of the differences between `|>` and `%>%` are that:

-   the base pipe only ever passes the left-hand side of the pipe into the first argument of the right-hand side;
-   and (because of this) we can no longer use the `.` notation.

The anonymous function defined above as `\(df) lm(mpg ~ wt, data = df))` is way around the issue with `.` notation. For the most part, the first point above (LHS into RHS) is rarely going to be an issue, particularly with `dplyr` functions. For example:

```{r}
mtcars %>%
  group_by(cyl) %>%
  summarise(av_mpg = mean(mpg))
```

is exactly the same as

```{r}
mtcars |>
  group_by(cyl) |>
  summarise(av_mpg = mean(mpg))
```

The problem for me, and the reason that I don't think I'll be switching to use `|>` in the near future is the `.` notation for when we don't want to pipe into the first argument. I quite often find myself piping into a function where the data isn't the first argument. To provide an example, let's create a small dataset.

```{r}
ex_df <- tibble(
  grp1 = rnorm(100, mean = 10, sd = 5), 
  grp2 = rnorm(100, mean = 20, sd = 5)
)
head(ex_df)
```

Suppose we wanted to perform a t-test. We have a number of choices

```{r}
t.test(ex_df$grp1, ex_df$grp2)
```

Alternatively we might want to change the data to long format, maybe add a cleaning step (which isn't needed for this example) and run the test using the formula notation.

```{r}
ex_df %>%
  pivot_longer(everything(), names_to = "group", values_to = "value") %>%
  # additional cleaning step ... %>%
  t.test(value ~ group, data = .)
```

Now if we try that with `|>` we know in advance that it won't work but I'm doing it here to generate the error

```{r, error = TRUE}
ex_df |>
  pivot_longer(everything(), names_to = "group", values_to = "value") |>
  # additional cleaning step ... |>
  t.test(value ~ group, data = .)
```

We can get around this if we really want, with an anonymous function.

```{r}
ex_df |>
  pivot_longer(everything(), names_to = "group", values_to = "value") |>
  (\(df) t.test(value ~ group, data = df))()
```

I quite like the notation of the anonymous functions but I'm not going to go into detail on them here because others have already provided excellent explanations. The [blog post](https://ivelasq.rbind.io/blog/understanding-the-r-pipe/) I linked above is one of them and I encourage you to read that too.

The conclusion I came to after this little bit of reading was that I'll stick to the magrittr pipe `%>%`, as i think the notation it leads to (include the `.` notation) is easier to read. The exception to this would be if I was writing a package. In that case I do try to limit the dependencies and it might be worthwhile using `|>` and anonymous functions.

## Other Pipes

As part of the reading I did, I also revisited the other pipes available from the `magrittr` package and it was really good reminder of what the options were. The ones I think I'll end up using the most are the assignment pipe `%<>%` and what I'll probably end up column the *column* pipe (the exposition pipe) `%$%`.

The `%$%` provides an alternative to the above `t.test()` notation as it allows us to access the columns directly.

```{r}
library(magrittr)
ex_df %$% 
  t.test(grp1, grp2)
```

The assignment pipe saves me some typing for things I do a lot by replacing

```{r, eval = FALSE}
ex_df <- ex_df %>%
   pivot_longer(everything(), names_to = "group", values_to = "value")
```

with

```{r}
ex_df %<>% pivot_longer(everything(), names_to = "group", values_to = "value")
head(ex_df)
```

## Final Thoughts

If you are reading this and haven't already, then I would really encourage you to read the [blog post](https://ivelasq.rbind.io/blog/understanding-the-r-pipe/). I'm a big fan of the pipe and will continue to use it but for my personal work, I think I'll stick with the `magrittr` pipe rather than switch to the base pipe. 

